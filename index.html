<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <!-- Loads quiz questions -->
  <script src="assets/questions.js"></script>
  <title>Coding Quiz Challenge</title>
</head>

<body>
  <div class="container bg-light">
    <div class="row align-middle">
      <nav class="col-1">
        <a id="view-scores" href="">View High Scores</a>
      </nav>
      <header class="col">
        <h1>Coding Quiz Challenge</h1>
      </header>
      <div class="col-1">
        Time: &nbsp;<span id="time-remaining">0</span>
        <div id="aria-timer" role="progressbar" aria-valuemin="0"></div>
      </div>
    </div>
    <main class="row">
      <div id="start-page" class="col">
        <p class="text-info">Try to answer the following code-related questions within the time limit. Keep in mind that
          incorrect answers will penalize your score/time by ten seconds!
        </p>
        <br>
        <div class="row">
          <div class="col text-center">
            <button id="start-quiz">Start Quiz</button>
          </div>
        </div>
      </div>

      <div id="quiz-page" class="col d-none">
        <div class="row">
          <div class="col text-center">
            <h4 id="question" role="alert"></h4>
          </div>
        </div>
        <div class="row">
          <div class="col text-center p-3">
            <ul id="response-list" class="list-group"></ul>
          </div>
        </div>
        <div class="row">
          <div class="col text-center">
            <h3 id="correct" class="text-white bg-success d-none" role="alert">Correct!</h3>
            <h3 id="incorrect" class="text-white bg-warning d-none" role="alert">Incorrect.</h3>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

  <!-- Main app script -->
  <script>
    $(document).ready(function () {
      // Assign hooks into various DOM elements
      var viewScoresAnchor = $("#view-scores");
      var timeSpan = $("#time-remaining");
      var ariaTimer = $("#aria-timer");
      var startPageDiv = $("#start-page");
      var startQuizButton = $("#start-quiz");
      var quizPageDiv = $("#quiz-page");
      var questionH4 = $("#question");
      var responseList = $("#response-list");
      var correctH3 = $("#correct");
      var incorrectH3 = $("#incorrect");

      // Variables for timer functionality
      var timeRemaining;
      var timerId;

      // Keeps track of which question is being shown
      var questionIndex;

      // Event Listeners

      viewScoresAnchor.click(function (event) {
        event.preventDefault();

        // Check to see if high scores array exists in local storage
        var highScoresRaw = localStorage.getItem("highScores");

        // If exists, convert to array and display it to user
        if (highScoresRaw !== "null") {
          try {
            var highScores = JSON.parse(highScoresRaw);

            var scoresText = "HIGH SCORES\n\n";

            highScores.forEach(function (scr) {
              scoresText += scr.initials + ": " + scr.score + "\n";
            });
            alert(scoresText);
          } catch (ex) {
            alert("Problem retrieving scores.\nError:  " + ex);
          }
        } else {
          alert("No scores to display.");
        }
      });

      startQuizButton.click(function (Event) {
        event.preventDefault();

        initializeQuizVariables();
        showQuiz();
        timerId = setInterval(updateTimer, 1000);
        showQuestion(questionIndex);
      });

      // Methods

      function initializeQuizVariables() {
        // Sets all variables to their initial values

        questionIndex = 0;

        // Initialize timer, giving 15 seconds per question
        timeRemaining = questions.length * 15;

        // Initialize accessible readout of timer for screen reader users
        ariaTimer.attr("aria-valuemax", timeRemaining);
      }

      function showQuiz() {
        // Hide start page and show quiz
        startPageDiv.addClass("d-none");
        quizPageDiv.removeClass("d-none");
        correctH3.addClass("d-none");
        incorrectH3.addClass("d-none");
      }

      function updateTimer() {
        timeSpan.text(timeRemaining);
        ariaTimer.attr("aria-valuenow", timeRemaining);

        if (timeRemaining > 0) {
          timeRemaining--;
        } else {
          recordScore();
          return;
        }
      }

      function showStartPage() {
        // Hide quiz and show start page
        quizPageDiv.addClass("d-none");
        startPageDiv.removeClass("d-none");
        timeSpan.text(0);
      }

      function showQuestion(index) {
        // Shows the specified question

        // Show the title
        questionH4.text(questions[index].title);

        // Present the choices
        responseList.empty();
        questions[index].choices.forEach(function (choice) {
          responseList.append($("<li>").append($("<button>").addClass("btn choice-button").text(choice).click(function (event) {
            // We must add the click event handler for the choice buttons dynamically on the fly because they don't exist until created here
            event.preventDefault();

            // Determine if answer was correct or not and show corresponding output on page
            if ($(this).text() === questions[questionIndex].answer) {
              correctH3.removeClass("d-none");
              incorrectH3.addClass("d-none");
            } else {
              incorrectH3.removeClass("d-none");
              correctH3.addClass("d-none");

              // Deduct 10 points for being wrong
              if (timeRemaining > 10) {
                timeRemaining -= 10;
              } else {
                // If there aren't 10 seconds remaining in the game, end game and record the score
                timeRemaining = 0;
                setTimeout(recordScore, 1000);
                return;
              }
            }
            if (questionIndex < (questions.length - 1)) {
              // Move to the next question if there is one, otherwise end the game and record the score
              questionIndex++;
              setTimeout(showQuestion, 100, questionIndex);
            } else {
              recordScore();
              return;
            }
          })).addClass("list-group-item"));
        })

        $(".choice-button:first").focus();
      }

      function recordScore() {
        clearInterval(timerId);
        playerInitials = prompt("Your score is " + timeRemaining.toString() + ". Please enter your initials to save your score.");

        var highScores = null;
        var scoreData = {
          initials: playerInitials,
          score: timeRemaining.toString()
        };

        var highScoresRaw = localStorage.getItem("highScores");
        if (highScoresRaw !== "null") {
          try {
            highScores = JSON.parse(highScoresRaw);
            highScores.push(scoreData);
            localStorage.setItem("highScores", JSON.stringify(highScores));
          } catch (ex) {
            alert("Couldn't retrieve high scores\nError: " + ex);
          }
        } else {
          highScores = [scoreData];
          localStorage.setItem("highScores", JSON.stringify(highScores));
        }
        showStartPage();
      }
    });
  </script>
</body>

</html>